#!/bin/bash

# TODO: 
# - Store created files in tmp dir

assert_equals() {
  if [[ "$1" == "$2" ]]; then
      echo "Test passed"
      return 0
  else
      echo "Test failed!"
      vimdiff  <(echo "$1") <(echo "$2")
      return 1
  fi
}

cd "${0%/*}"/..
curdir="$(pwd)"
echo "Working directory: $curdir"

trap "rm -f ./tests/files/testdict.zip ./tests/files/data.mdb" EXIT

echo "Zipping test dictionary..."
zip -j -r ./tests/files/testdict.zip ./tests/files/testdictionary/*

echo "Creating index..."
dictpopup-create -d ./tests/files/ -i ./tests/files/

output=$(DICTPOPUP_CONFIG_DIR="$curdir" ./dictpopup-cli -d ./tests/files/ "é¢ç™½ã„")

expected_output=$'dictname: Test dictionary
kanji: é¢ç™½ã„
reading: ãŠã‚‚ã—ã‚ã„
definition: ãŠã‚‚ã—ã‚ãƒ»ã„[4]ã€é¢ç™½ã„ã€‘
ï¼ˆå½¢ï¼‰
(ã‚¯)ãŠã‚‚ã—ã‚ãƒ»ã—
ã€”ã€Œé¢(ãŠã‚‚)ç™½ã—ã€ã§ã€ç›®ã®å‰ãŒã±ã£ã¨æ˜Žã‚‹ããªã‚‹æ„Ÿã˜ã‚’è¡¨ã™ã®ãŒåŽŸç¾©ã¨ã„ã‚ã‚Œã‚‹ã€•
â‘ æ¥½ã—ã„ã€‚æ„‰å¿«ã ã€‚
ã€Œæ˜¨æ—¥è¦‹ãŸæ˜ ç”»ã¯â”ãƒ»ã‹ã£ãŸã€
ã€Œå‹‰å¼·ãŒâ”ãƒ»ãã¦ä»•æ–¹ãŒãªã„ã€
â‘¡èˆˆå‘³ã‚’ããã‚‹ã€‚èˆˆå‘³æ·±ã„ã€‚
ã€Œä½•ã‹â”ãƒ»ã„è©±ã¯ãªã„ã‹ã€
ã€Œæœ€å¾Œã«ãã¦â”ãƒ»ã„å±•é–‹ã‚’è¦‹ã›ã‚‹ã€
â‘¢ã“ã£ã‘ã„ã ã€‚ãŠã‹ã—ã„ã€‚
ã€Œâ”ãƒ»ã„ã—ãã•ã§äººã‚’ç¬‘ã‚ã›ã‚‹ã€
â‘£ï¼ˆå¤šãã€æ‰“ã¡æ¶ˆã—ã®èªžã‚’ä¼´ã†ï¼‰å¿ƒã«ã‹ãªã†ã€‚å¥½ã¾ã—ã„ã€‚æœ›ã¾ã—ã„ã€‚
ã€Œç—…çŠ¶ãŒâ”ãƒ»ããªã„ã€
ã€Œâ”ãƒ»ããªã„çµæžœã«çµ‚ã‚ã‚‹ã€
ã€Œç§ã«â”ãƒ»ã‹ã‚‰ã¬æ„Ÿæƒ…ã‚’æŠ±ã„ã¦ã„ã‚‹ã€
â‘¤æ™¯è‰²ãªã©ãŒæ˜Žã‚‹ãåºƒã€…ã¨ã—ãŸæ„Ÿã˜ã§ã€æ°—åˆ†ãŒã¯ã‚Œã°ã‚Œã¨ã™ã‚‹ã‚ˆã†ã ã€‚æ˜Žã‚‹ãç›®ãŒè¦šã‚ã‚‹ã‚ˆã†ã ã€‚
ã€Œåæ—¥ã‚ã¾ã‚Šãªã‚Œã°ã€æœˆâ”ãƒ»ã—ï¼åœŸå·¦æ—¥è¨˜ã€
â‘¥å¿ƒã‚’ã²ã‹ã‚Œã‚‹ã€‚è¶£ãŒæ·±ã„ã€‚é¢¨æµã ã€‚
ã€Œæ˜”ã‚’æ€ã²ã‚„ã‚Šã¦ã¿ã‚Œã°â”ãƒ»ã‹ã‚Šã‘ã‚‹æ‰€ãªã‚Šï¼åœŸå·¦æ—¥è¨˜ã€
ã€”é¡žç¾©ã®èªžã«ã€ŒãŠã‹ã—ã„ã€ãŒã‚ã‚‹ãŒã€ã€ŒãŠã‹ã—ã„ã€ã¯æ ¼å¥½ãƒ»è¡¨æƒ…ãƒ»ã—ãã•ãƒ»è©±ã—æ–¹ãªã©ãŒæ™®é€šã¨é•ã£ã¦ã„ã¦ã€ç¬‘ã„ãŸããªã‚‹æ„ã‚’è¡¨ã™ã€‚ãã‚Œã«å¯¾ã—ã¦ã€ŒãŠã‚‚ã—ã‚ã„ã€ã¯å¯¾è±¡ãŒæ™®é€šã®åŸºæº–ã‹ã‚‰è¦‹ã‚‹ã¨æ–°é®®ãƒ»å¥‡æŠœã§å¤‰åŒ–ã«å¯Œã‚“ã§ã„ã¦ã€èˆˆå‘³ã‚’ããã‚‹æ„ã‚’è¡¨ã™ã€•
â”ãŒãƒ»ã‚‹ï¼ˆå‹•(ãƒ©)äº”ï¼»å››ï¼½ï¼‰ãƒ»â”ã’ï¼ˆå½¢å‹•ï¼‰ãƒ»â”ã•ï¼ˆåï¼‰ãƒ»â”ã¿ï¼ˆåï¼‰

dictname: Test dictionary
kanji: é¢ç™½ã„
reading: ãŠã‚‚ã—ã‚ã„
definition: â‘   
\tâ€¢ interesting
\tâ€¢ fascinating
\tâ€¢ intriguing
\tâ€¢ enthralling
\tâ—¦ æ–°èžã«ã¯ä½•ã‚‚é¢ç™½ã„ã“ã¨ã¯è¼‰ã£ã¦ã„ãªã„ã€‚
\t   There is nothing interesting in the newspaper.
â‘¡  
\tâ€¢ amusing
\tâ€¢ funny
\tâ€¢ comical
\tâ—¦ ã“ã‚Œã¯ç§ãŒèª­ã‚“ã ä¸­ã§ä¸€ç•ªé¢ç™½ã„æœ¬ã§ã™ã€‚
\t   This is the funniest book in my reading.
\tâ—¦ å½¼å¥³ã¯å­ä¾›ãŸã¡ã«é¢ç™½ã„è©±ã‚’ã—ã¦ã‚ã’ãŸã€‚
\t   She told her children an amusing story.
â‘¢  
\tâ€¢ enjoyable
\tâ€¢ fun
\tâ€¢ entertaining
\tâ€¢ pleasant
\tâ€¢ agreeable
\tâ—¦ ã“ã®æœ¬ã¯é¢ç™½ã„èª­ã¿ç‰©ã§ã™ã€‚
\t   This book makes pleasant reading.
\tâ—¦ é‡Žé³¥ã‚’è¦³å¯Ÿã™ã‚‹ã®ã¯ã¨ã¦ã‚‚é¢ç™½ã„ã€‚
\t   Watching wild birds is great fun.
â‘£  
\tâ€¢ good
\tâ€¢ satisfactory
\tâ€¢ favourable
\tâ€¢ desirable
\tâ€¢ encouraging
\tðŸ“  usu. in the negative

dictname: Test dictionary
kanji: é¢ç™½ã„
reading: ãŠã‚‚ã—ã‚ã„
definition: ãŠã‚‚â€ã—ã‚ãƒ»ã„ã€Ã—é¢ç™½ã„ã€‘ï¼ˆå½¢ï¼‰ã€Šã‚«ãƒ­ãƒ»ã‚«ãƒ„ï¼ˆã‚¯ï¼‰ãƒ»ã‚¤ãƒ»ã‚¤ãƒ»ã‚±ãƒ¬ãƒ»â—‹ã€‹
â‘  æº€è¶³ã§ãã‚‹å†…å®¹ã§ã‚ã‚Šå¿ƒã²ã‹ã‚Œã‚‹ã€‚æ„‰å¿«ã ã€‚æ¥½ã—ã„ã€‚ã€Œã‚ã®äººã¯â€•ã€
â‘¡ ç™ºå±•ãŒæœŸå¾…ã§ãèˆˆå‘³æ·±ã„ã€‚ã€Œãªã‹ãªã‹â€•æ„è¦‹ã ã€
â‘¢ ç¬‘ã„å‡ºã—ãŸããªã‚‹ã€‚ãŠã‹ã—ã„ã€‚ã“ã£ã‘ã„ã ã€‚
â‘£ å¥½ã¾ã—ã„ã€‚ã€Œã©ã†ã‚‚çµæžœãŒâ€•ãƒ»ããªã„ã€
ã€”æ–‡ã€•ãŠã‚‚ã—ã‚ãƒ»ã—ï¼ˆã‚¯ï¼‰
ã€Œé¢ï¼ˆãŠã‚‚ï¼‰ã€ã¯ç›®å‰ã®æƒ…æ™¯ã§ã€ãã‚ŒãŒåºƒã€…ã¨ã²ã‚‰ã‘ã‚‹æ„ã‹ã‚‰ã€‚
â‘£ã¯ã€å¤šãã‚ã¨ã«æ‰“ã¡æ¶ˆã—ã®èªžã‚’ä¼´ã†ã€‚

dictname: Test dictionary
kanji: é¢ç™½ã„
reading: ãŠã‚‚ã—ã‚ã„
definition: ãŠã‚‚ã—ã‚ã„ã€é¢ç™½ã„ã€‘é¢ç™½ã„ï¼æ„‰å¿«ï¼ç—›å¿«
å¿ƒãŒæ¥½ã—ãã€ãŠã‹ã—ãã€æ°—æŒã¡ãŒæ™´ã‚Œã‚‹ã‚ˆã†ãªã•ã¾ã€‚
ðŸ“šä½¿ã„æ–¹
â—¦ é¢ç™½ã„ ã€å½¢ã€‘ â–½é¢ç™½ã„ã‚ˆã†ã«é­šãŒé‡£ã‚ŒãŸÂ â–½ãã®å­¦èª¬ã¯é¢ç™½ã„
â—¦ æ„‰å¿« ã€åãƒ»å½¢å‹•ã€‘ â–½æ¯Žæ—¥æ„‰å¿«ã«éŽã”ã—ã¦ã„ã‚‹Â â–½æ„‰å¿«ãªä»²é–“
â—¦ ç—›å¿« ã€åãƒ»å½¢å‹•ã€‘ â–½å½¼ã®ç™ºè¨€ã¯ç—›å¿«ã ã£ãŸÂ â–½é€†è»¢å‹ã¡ã—ãŸç—›å¿«ãªè©¦åˆ
ðŸ”„ä½¿ã„åˆ†ã‘
ï¼‘ ã€Œé¢ç™½ã„ã€ã¯ã€åºƒã„æ„å‘³ã‚’æŒã¤èªžã€‚å–œã°ã—ãã€å¿ƒãŒã²ã‹ã‚Œã‚‹ã•ã¾ã‚’ã„ã†ã€‚ãŠã‹ã—ã„ã®æ„å‘³ã®ã¨ãã¯ã€Œæ„‰å¿«ã€ã«é‡ãªã‚Šã€èƒ¸ãŒã™ãã®æ„å‘³ã§ã¯ã€Œç—›å¿«ã€ã«é‡ãªã‚‹ã€‚ã¾ãŸã€ä¸€é¢¨å¤‰ã‚ã£ã¦ã„ãŸã‚Šæ–°é®®ã§ã‚ã£ãŸã‚Šã—ã¦ã€èˆˆå‘³ã‚’ã²ã‹ã‚Œã‚‹ã•ã¾ã«ã‚‚ã„ã†ãŒã€ã“ã®æ„å‘³ã§ã¯ä»–ã®äºŒèªžã¨ã¯é‡ãªã‚‰ãªã„ã€‚
ï¼’ ã€Œæ„‰å¿«ã€ã¯ã€ãŠã‹ã—ãã¦ç¬‘ã„ã‚’èª˜ã†ã‚ˆã†ãªã•ã¾ã‚’ã„ã†ã€‚
ï¼“ ã€Œç—›å¿«ã€ã¯ã€æ¥½ã—ãã€èƒ¸ã®æ™´ã‚Œã‚‹ã•ã¾ã€èƒ¸ã®ã¤ã‹ãˆãŒå–ã‚Šæ‰•ã‚ã‚Œã¦ã™ã£ã¨ã™ã‚‹ã‚ˆã†ãªã•ã¾ã‚’ã„ã†ã€‚ã¾ãŸã€å˜ã«è±ªå¿«ã§æ°—åˆ†ã®ã‚ˆã„ã•ã¾ãªã©ã«ã‚‚ç”¨ã„ã‚‹ã€‚ã€Œç—›å¿«ãªé£²ã¿ã£ã·ã‚Šã€ã€Œç—›å¿«ãªç”·ã€'

assert_equals "$output" "$expected_output"
